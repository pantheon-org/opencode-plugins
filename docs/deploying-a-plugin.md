# Deploying a Generated Plugin

> **Last Updated**: December 2024  
> **Audience**: Plugin developers  
> **Prerequisites**: Plugin generated using `bun run generate:plugin`

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [One-Time Setup](#one-time-setup)
- [Development Workflow](#development-workflow)
- [First Release (v0.1.0)](#first-release-v010)
- [Subsequent Releases](#subsequent-releases)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

---

## Overview

This guide walks you through deploying a plugin generated by the Nx generator. The deployment process uses a
**mirror-based strategy** where:

1. You develop in the monorepo (`packages/<plugin-name>/`)
2. On tag push, code automatically mirrors to a standalone repository
3. The mirror repository handles npm publication and documentation deployment

**Key Files to Understand:**

- `package.json` - Contains plugin metadata and mirror repository URL
- `.github/.release-please-manifest.json` - Tracks the initial version
- `.github/release-please-config.json` - Configures release automation
- `.github/workflows/` - CI/CD workflows for the mirror repository

---

## Prerequisites

Before deploying, ensure you have:

- [x] Generated a plugin using `bun run generate:plugin <plugin-name>`
- [x] Implemented your plugin functionality
- [x] Written tests and documentation
- [x] Created a mirror repository on GitHub
- [x] Configured `MIRROR_REPO_TOKEN` secret (see [setup-mirror-repo-token.md](./setup-mirror-repo-token.md))
- [x] Added `NPM_TOKEN` secret to the mirror repository

### Check Your Plugin Structure

Your generated plugin should have:

```
packages/opencode-<your-plugin>/
├── .github/
│   ├── .release-please-manifest.json
│   ├── release-please-config.json
│   └── workflows/
│       ├── release-and-publish.yml
│       └── publish-on-tag.yml
├── src/
│   └── index.ts
├── package.json
└── README.md
```

---

## One-Time Setup

### Step 1: Create Mirror Repository

Create a public repository on GitHub for your plugin:

```bash
gh repo create pantheon-org/opencode-<your-plugin> \
  --public \
  --description "OpenCode plugin for <description>" \
  --homepage "https://github.com/pantheon-org/opencode-<your-plugin>"
```

**Important**: The repository name must match your plugin package name without the scope:

- Package: `@pantheon-org/opencode-my-plugin`
- Repository: `pantheon-org/opencode-my-plugin`

### Step 2: Verify package.json Configuration

Check that your plugin's `package.json` has the correct repository URL:

```json
{
  "name": "@pantheon-org/opencode-<your-plugin>",
  "version": "0.1.0",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/pantheon-org/opencode-<your-plugin>.git"
  }
}
```

**The `repository.url` must match the mirror repository you created.**

### Step 3: Configure npm Token

Add your npm authentication token to the mirror repository:

```bash
# Get your npm token from https://www.npmjs.com/settings/<your-username>/tokens
# Create a token with "Automation" type and "Publish" permission

# Add it as a secret to the mirror repository
gh secret set NPM_TOKEN --repo pantheon-org/opencode-<your-plugin>
# Paste your npm token when prompted
```

### Step 4: Verify MIRROR_REPO_TOKEN

Ensure the monorepo has the `MIRROR_REPO_TOKEN` secret configured:

```bash
# Check if secret exists
gh secret list | grep MIRROR_REPO_TOKEN

# If not found, see setup-mirror-repo-token.md for configuration
```

---

## Development Workflow

### 1. Develop Your Plugin

Make changes in the monorepo:

```bash
cd packages/opencode-<your-plugin>

# Edit your plugin code
vim src/index.ts

# Run tests
bun test

# Type check
bun run type-check

# Lint
bun run lint
```

### 2. Commit with Conventional Commits

Use conventional commit messages to trigger proper version bumps:

```bash
git add packages/opencode-<your-plugin>

# For new features (minor version bump: 0.1.0 → 0.2.0)
git commit -m "feat(<plugin-name>): add new feature description"

# For bug fixes (patch version bump: 0.1.0 → 0.1.1)
git commit -m "fix(<plugin-name>): fix specific issue"

# For breaking changes (major version bump: 0.1.0 → 1.0.0)
git commit -m "feat(<plugin-name>)!: breaking change description

BREAKING CHANGE: Explain what breaks and migration path"

git push origin main
```

**Commit Types:**

- `feat:` - New feature (minor bump)
- `fix:` - Bug fix (patch bump)
- `feat!:` or `BREAKING CHANGE:` - Breaking change (major bump)
- `docs:`, `chore:`, `style:` - No release triggered

### 3. Update Package Version

Update the version in `package.json` to match your intended release:

```bash
# Edit package.json version
vim packages/opencode-<your-plugin>/package.json

# Change version to your target (e.g., 0.2.0)
```

---

## First Release (v0.1.0)

### Step 1: Commit Final Changes

```bash
cd /path/to/opencode-plugins

# Ensure all changes are committed
git add packages/opencode-<your-plugin>
git commit -m "feat(<plugin-name>): initial plugin implementation"
git push origin main
```

### Step 2: Create and Push Tag

```bash
# Tag format: <package-directory-name>@v<version>
# Example: opencode-my-plugin@v0.1.0

git tag opencode-<your-plugin>@v0.1.0
git push origin opencode-<your-plugin>@v0.1.0
```

**Note**: If pre-push hooks fail (e.g., no tests), use:

```bash
git push --no-verify origin opencode-<your-plugin>@v0.1.0
```

### Step 3: Monitor Mirror Workflow

1. Go to the monorepo Actions tab: https://github.com/pantheon-org/opencode-plugins/actions
2. Find the "Mirror Packages to Repositories" workflow
3. Verify it completes successfully

Expected output:

- ✅ Package detected: `opencode-<your-plugin>`
- ✅ Mirror URL validated
- ✅ Changes detected
- ✅ Subtree split complete
- ✅ Pushed to mirror repository

### Step 4: Verify Mirror Repository

Check that your code was mirrored:

```bash
# Check mirror repository
gh repo view pantheon-org/opencode-<your-plugin>

# Verify tag exists
gh api repos/pantheon-org/opencode-<your-plugin>/tags --jq '.[].name'
# Should output: v0.1.0

# Check files are present
gh api repos/pantheon-org/opencode-<your-plugin>/contents --jq '.[] | .name'
```

### Step 5: Monitor Release Workflow

The mirror repository should automatically trigger Release Please:

```bash
# Check workflows in mirror repo
gh run list --repo pantheon-org/opencode-<your-plugin> --limit 5
```

**Expected behavior:**

- Release Please analyzes conventional commits
- Creates a release PR or directly creates a release (depending on configuration)
- Triggers npm publication
- Deploys documentation to GitHub Pages

### Step 6: Verify Publication

Check that your package is published:

```bash
# Check npm
npm view @pantheon-org/opencode-<your-plugin>

# Should show:
# - name: @pantheon-org/opencode-<your-plugin>
# - version: 0.1.0
# - Other package details
```

---

## Subsequent Releases

For future releases, follow this workflow:

### 1. Make Changes and Commit

```bash
cd packages/opencode-<your-plugin>

# Make your changes
vim src/index.ts

# Test
bun test

# Commit with conventional commit message
git add .
git commit -m "feat: add awesome new feature"
git push origin main
```

### 2. Update Version

```bash
# Edit package.json to bump version
# 0.1.0 → 0.2.0 (for feat:)
# 0.1.0 → 0.1.1 (for fix:)
# 0.1.0 → 1.0.0 (for breaking changes)

vim packages/opencode-<your-plugin>/package.json

git add packages/opencode-<your-plugin>/package.json
git commit -m "chore: bump version to 0.2.0"
git push origin main
```

### 3. Tag and Release

```bash
# Create tag with new version
git tag opencode-<your-plugin>@v0.2.0
git push --no-verify origin opencode-<your-plugin>@v0.2.0
```

### 4. Monitor and Verify

Same as First Release steps 3-6.

---

## Troubleshooting

### Mirror Workflow Fails

#### Issue: "Package directory does not exist"

**Cause**: Tag name doesn't match directory name in `packages/`

**Solution**:

```bash
# Tag must exactly match directory name
# Correct: opencode-my-plugin@v1.0.0 (for packages/opencode-my-plugin/)
# Wrong:   my-plugin@v1.0.0

# Delete incorrect tag
git tag -d opencode-<your-plugin>@v1.0.0
git push origin :refs/tags/opencode-<your-plugin>@v1.0.0

# Create correct tag
git tag opencode-<your-plugin>@v1.0.0  # Must match directory name exactly
git push origin opencode-<your-plugin>@v1.0.0
```

#### Issue: "No repository URL found in package.json"

**Cause**: Missing or incorrect `repository.url` in `package.json`

**Solution**:

```bash
# Add repository field
cd packages/opencode-<your-plugin>
vim package.json

# Add:
{
  "repository": {
    "type": "git",
    "url": "git+https://github.com/pantheon-org/opencode-<your-plugin>.git"
  }
}

# Commit and retry
git add package.json
git commit -m "fix: add repository URL to package.json"
git push origin main

git tag -d opencode-<your-plugin>@v1.0.0
git push origin :refs/tags/opencode-<your-plugin>@v1.0.0
git tag opencode-<your-plugin>@v1.0.0
git push origin opencode-<your-plugin>@v1.0.0
```

#### Issue: "Permission denied to github-actions[bot]"

**Cause**: `MIRROR_REPO_TOKEN` doesn't have correct permissions

**Solution**: See [setup-mirror-repo-token.md](./setup-mirror-repo-token.md) and ensure token has:

- ✅ Contents: Read and write
- ✅ Workflows: Read and write

#### Issue: "No changes detected - mirror sync skipped"

**Explanation**: This is intentional - the workflow skips mirroring if nothing changed since the last tag.

**When this happens**: You're trying to re-release the same code.

**Solution**: Make actual changes before creating a new release.

### Release Workflow Fails

#### Issue: Workflow fails instantly (0s duration)

**Cause**: YAML syntax error or missing files in mirror repository

**Solution**:

```bash
# Clone mirror repo to debug
git clone https://github.com/pantheon-org/opencode-<your-plugin>
cd opencode-<your-plugin>

# Check workflow files exist
ls -la .github/workflows/

# Validate YAML syntax
yamllint .github/workflows/release-and-publish.yml

# Check for missing files
ls -la .github/actions/
```

#### Issue: "NPM_TOKEN not found"

**Cause**: npm token secret not configured in mirror repository

**Solution**:

```bash
gh secret set NPM_TOKEN --repo pantheon-org/opencode-<your-plugin>
# Paste your npm token when prompted
```

#### Issue: "Version mismatch between package.json and tag"

**Cause**: `package.json` version doesn't match the git tag

**Solution**:

```bash
# Update package.json to match tag
vim packages/opencode-<your-plugin>/package.json
# Set version to match tag (e.g., tag v1.0.0 → version "1.0.0")

git add packages/opencode-<your-plugin>/package.json
git commit -m "chore: sync package.json version with tag"
git push origin main

# Re-push tag to trigger mirror
git tag -d opencode-<your-plugin>@v1.0.0
git push origin :refs/tags/opencode-<your-plugin>@v1.0.0
git tag opencode-<your-plugin>@v1.0.0
git push origin opencode-<your-plugin>@v1.0.0
```

### npm Publication Fails

#### Issue: "You cannot publish over the previously published versions"

**Cause**: Version already exists on npm

**Solution**:

```bash
# Bump version to next patch/minor/major
vim packages/opencode-<your-plugin>/package.json
# Increment version (e.g., 1.0.0 → 1.0.1)

git add packages/opencode-<your-plugin>/package.json
git commit -m "chore: bump version to 1.0.1"
git push origin main

git tag opencode-<your-plugin>@v1.0.1
git push origin opencode-<your-plugin>@v1.0.1
```

#### Issue: "Package name conflict"

**Cause**: Package name already taken on npm

**Solution**:

```bash
# Check if package exists
npm view @pantheon-org/opencode-<your-plugin>

# If taken, choose a different name
vim packages/opencode-<your-plugin>/package.json
# Change "name" to something unique

# Also update mirror repo URL to match
```

---

## Best Practices

### 1. Use Conventional Commits

Always use conventional commit messages:

```bash
# ✅ Good
git commit -m "feat(notifications): add sound toggle option"
git commit -m "fix(auth): correct token refresh logic"

# ❌ Bad
git commit -m "updates"
git commit -m "fixed stuff"
```

### 2. Test Before Tagging

Run full test suite before creating a release:

```bash
# In plugin directory
bun test
bun run type-check
bun run lint
bun run build

# If all pass, proceed with tagging
```

### 3. Keep Versions in Sync

Always update `package.json` version before tagging:

```bash
# ✅ Good
# 1. Update package.json to 0.2.0
# 2. Commit
# 3. Tag as opencode-<plugin>@v0.2.0

# ❌ Bad
# 1. Tag as v0.2.0
# 2. package.json still at 0.1.0
# (Version mismatch causes workflow failures)
```

### 4. Monitor Workflows

After pushing a tag, always verify:

```bash
# 1. Mirror workflow succeeded
gh run list --limit 1

# 2. Mirror repo updated
gh api repos/pantheon-org/opencode-<your-plugin>/tags --jq '.[0].name'

# 3. Release created (if Release Please workflow succeeded)
gh release list --repo pantheon-org/opencode-<your-plugin>

# 4. Package published
npm view @pantheon-org/opencode-<your-plugin>
```

### 5. Document Changes

Maintain a clear CHANGELOG or release notes:

- Release Please generates CHANGELOG automatically from commits
- Ensure commit messages are descriptive
- Reference issues/PRs in commit messages

### 6. Semantic Versioning

Follow semantic versioning:

- **Major (1.0.0 → 2.0.0)**: Breaking changes
- **Minor (1.0.0 → 1.1.0)**: New features, backwards compatible
- **Patch (1.0.0 → 1.0.1)**: Bug fixes, backwards compatible

### 7. Test in Mirror Repo

If workflows fail, test locally:

```bash
# Clone mirror repo
git clone https://github.com/pantheon-org/opencode-<your-plugin>
cd opencode-<your-plugin>

# Run build and publish steps locally
bun install
bun test
bun run build
npm pack --dry-run
```

---

## Quick Reference

### Common Commands

```bash
# Generate new plugin
bun run generate:plugin my-awesome-feature

# First release
git tag opencode-my-awesome-feature@v0.1.0
git push origin opencode-my-awesome-feature@v0.1.0

# Subsequent release
git tag opencode-my-awesome-feature@v0.2.0
git push --no-verify origin opencode-my-awesome-feature@v0.2.0

# Check mirror workflow
gh run list --limit 1

# Check mirror repo
gh repo view pantheon-org/opencode-my-awesome-feature

# Verify npm package
npm view @pantheon-org/opencode-my-awesome-feature
```

### Tag Format Reference

```bash
# Correct format
<directory-name>@v<version>

# Examples
opencode-my-plugin@v0.1.0          ✅
opencode-notifications@v1.2.3      ✅
opencode-auth-helper@v2.0.0        ✅

# Incorrect formats
my-plugin@v0.1.0                   ❌ (missing prefix)
opencode-my-plugin-v0.1.0          ❌ (wrong separator)
v0.1.0                             ❌ (missing package name)
```

---

## Related Documentation

- [Release Process](./release-process.md) - Detailed release architecture
- [Setup Mirror Repo Token](./setup-mirror-repo-token.md) - Token configuration
- [Plugin Generator README](../tools/generators/plugin/README.md) - Generator documentation
- [Bun & TypeScript Standards](../.opencode/knowledge-base/bun-typescript-development.md) - Development standards

---

## Support

If you encounter issues:

1. Check [Troubleshooting](#troubleshooting) section above
2. Review workflow logs: `gh run view <run-id> --log`
3. Check mirror repository: `gh repo view pantheon-org/opencode-<your-plugin>`
4. Open an issue in the monorepo with workflow logs attached

---

**Last Updated**: December 2024  
**Maintained By**: Pantheon Engineering
