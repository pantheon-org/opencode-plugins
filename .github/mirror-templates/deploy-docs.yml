name: Deploy Documentation to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages-${{ github.ref }}'
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4.2
        with:
          fetch-depth: 0

      - name: Setup Bun with caching
        uses: ./.github/actions/setup-bun

      - name: Clone docs-builder
        run: |
          echo "ðŸ“¥ Cloning opencode-docs-builder..."
          git clone --depth 1 https://github.com/pantheon-org/opencode-docs-builder.git docs-builder
          echo "âœ… Docs builder cloned"

      - name: Install docs-builder dependencies
        working-directory: ./docs-builder
        run: |
          echo "ðŸ“¦ Installing docs-builder dependencies..."
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Install Playwright browsers
        working-directory: ./docs-builder
        run: |
          echo "ðŸŽ­ Installing Playwright browsers..."
          bunx playwright install --with-deps chromium
          echo "âœ… Playwright browsers installed"

      - name: Prepare documentation structure
        run: |
          echo "ðŸ“š Preparing documentation structure..."

          # Extract package metadata
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_DESC=$(node -p "require('./package.json').description || 'OpenCode Plugin'")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          REPO_NAME="${{ github.event.repository.name }}"

          echo "ðŸ“¦ Package: $PACKAGE_NAME"
          echo "ðŸ“ Description: $PACKAGE_DESC"
          echo "ðŸ·ï¸  Version: $PACKAGE_VERSION"
          echo "ðŸ“ Repository: $REPO_NAME"

          # Create content directory
          mkdir -p docs-builder/src/content/docs

          # Copy plugin documentation
          if [ -d "docs" ]; then
            echo "âœ… Copying docs/ directory..."
            cp -r docs/* docs-builder/src/content/docs/
          else
            echo "âš ï¸  No docs/ directory found"
          fi

          # Copy README as index page
          if [ -f "README.md" ]; then
            echo "âœ… Copying README.md as index..."
            cp README.md docs-builder/src/content/docs/index.md
          else
            echo "âš ï¸  No README.md found"
          fi

          # Generate Astro configuration
          cat > docs-builder/astro.config.mjs << 'EOF'
          import { defineConfig } from 'astro/config';
          import starlight from '@astrojs/starlight';

          export default defineConfig({
            site: 'https://pantheon-org.github.io',
            base: '/${{ github.event.repository.name }}',
            integrations: [
              starlight({
                title: process.env.PACKAGE_NAME || '${{ github.event.repository.name }}',
                description: process.env.PACKAGE_DESC || 'OpenCode Plugin Documentation',
                social: {
                  github: 'https://github.com/${{ github.repository }}',
                },
                sidebar: [
                  {
                    label: 'Documentation',
                    autogenerate: { directory: '.' },
                  },
                ],
                customCss: [
                  './src/styles/custom.css',
                ],
                lastUpdated: true,
                editLink: {
                  baseUrl: 'https://github.com/${{ github.repository }}/edit/main/',
                },
              }),
            ],
          });
          EOF

          echo "âœ… Astro config generated"

          # Set environment variables for build
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "PACKAGE_DESC=$PACKAGE_DESC" >> $GITHUB_ENV
          echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Transform documentation
        working-directory: ./docs-builder
        run: |
          echo "ðŸ”„ Transforming documentation..."
          bun run transform || echo "âš ï¸ Transform script not available, skipping..."
          echo "âœ… Documentation transformed"

      - name: Generate favicon
        working-directory: ./docs-builder
        run: |
          echo "ðŸŽ¨ Generating favicon..."
          bun run generate-favicon || echo "âš ï¸ Favicon generation not available, skipping..."

      - name: Build documentation site
        working-directory: ./docs-builder
        env:
          PACKAGE_NAME: ${{ env.PACKAGE_NAME }}
          PACKAGE_DESC: ${{ env.PACKAGE_DESC }}
        run: |
          echo "ðŸ—ï¸  Building Astro documentation site..."
          bun run build
          echo "âœ… Documentation site built successfully"

      - name: Fix links
        working-directory: ./docs-builder
        run: |
          echo "ðŸ”— Fixing internal links..."
          bun run fix-links || echo "âš ï¸ Link fixing not available, skipping..."

      - name: Verify links
        working-directory: ./docs-builder
        run: |
          echo "âœ… Verifying internal links..."
          bun run verify || echo "âš ï¸ Link verification not available, skipping..."

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3.0
        with:
          path: docs-builder/dist

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0

      - name: Display deployment URL
        run: |
          echo "ðŸš€ Documentation deployed successfully!"
          echo "ðŸ“– URL: ${{ steps.deployment.outputs.page_url }}"

  summary:
    name: Deployment Summary
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Job Summary
        run: |
          echo "## ðŸ“– Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URL**: ${{ needs.deploy.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Build Process" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ“¥ Cloned \`opencode-docs-builder\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“„ Copied plugin docs from \`./docs/\`" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ“ Copied \`README.md\` as index page" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ”„ Transformed markdown to Astro content" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ—ï¸  Built static site with Starlight" >> $GITHUB_STEP_SUMMARY
            echo "6. ðŸ”— Fixed and verified internal links" >> $GITHUB_STEP_SUMMARY
            echo "7. ðŸš€ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs above for error details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Pages not enabled (Settings > Pages > Source: GitHub Actions)" >> $GITHUB_STEP_SUMMARY
            echo "- Invalid markdown in docs directory" >> $GITHUB_STEP_SUMMARY
            echo "- Missing or corrupted README.md" >> $GITHUB_STEP_SUMMARY
            echo "- docs-builder repository unavailable" >> $GITHUB_STEP_SUMMARY
          fi
