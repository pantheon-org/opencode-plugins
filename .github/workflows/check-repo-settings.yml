name: Check Repository Settings

# Scheduled workflow to detect configuration drift in repository settings
# Runs weekly to ensure branch protection and cleanup settings are maintained

on:
  schedule:
    # Weekly on Monday at midnight UTC to detect configuration drift
    # Weekly frequency is sufficient for drift detection while minimizing API usage
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering for ad-hoc checks

permissions:
  contents: read # For reading repository settings and branch protection
  issues: write # For creating/updating/closing issues

jobs:
  check-settings:
    name: Verify Branch Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build workflows app
        run: bunx nx build workflows

      - name: Run repository settings check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: node dist/apps/workflows/apps/workflows/src/scripts/check-repo-settings/index.js
