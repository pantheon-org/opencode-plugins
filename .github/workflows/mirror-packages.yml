name: Mirror Packages to Repositories

on:
  push:
    tags:
      - '*@v*' # Matches any package tag like opencode-foo-plugin@v1.0.0

jobs:
  detect-package:
    runs-on: ubuntu-latest
    outputs:
      package-name: ${{ steps.parse.outputs.package }}
      package-dir: ${{ steps.parse.outputs.dir }}
      version: ${{ steps.parse.outputs.version }}
      mirror-url: ${{ steps.validate.outputs.url }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse tag to get package name
        id: parse
        run: bun run apps/workflows/src/scripts/mirror-package/parse-tag.ts

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Validate mirror repository URL
        id: validate
        run: bun run apps/workflows/src/scripts/mirror-package/validate-mirror-url.ts "packages/${{ steps.parse.outputs.package }}/package.json"

      - name: Detect changes in package
        id: changes
        run: bun run apps/workflows/src/scripts/mirror-package/detect-changes.ts "${{ steps.parse.outputs.package }}" "${{ steps.parse.outputs.dir }}"

  mirror-to-repo:
    needs: detect-package
    runs-on: ubuntu-latest
    if: needs.detect-package.outputs.has-changes == 'true'
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Extract package subdirectory
        run: |
          echo "ðŸ”§ Extracting ${{ needs.detect-package.outputs.package-dir }} to temporary branch..."
          git subtree split --prefix=${{ needs.detect-package.outputs.package-dir }} -b temp-branch
          echo "âœ… Subtree split complete"

      - name: Add CI/CD workflows to mirror
        run: |
          echo "ðŸ“‹ Adding CI/CD workflows and actions to mirror branch..."
          git checkout temp-branch

          # Create .github directory structure
          mkdir -p .github/workflows
          mkdir -p .github/actions/setup-bun
          mkdir -p .github/actions/setup-node-npm

          # Copy workflow templates from monorepo
          cp .github/mirror-templates/publish-npm.yml .github/workflows/
          cp .github/mirror-templates/deploy-docs.yml .github/workflows/

          # Copy composite actions
          cp .github/mirror-templates/actions/setup-bun/action.yml .github/actions/setup-bun/
          cp .github/mirror-templates/actions/setup-node-npm/action.yml .github/actions/setup-node-npm/

          # Commit the workflows and actions
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add .github
          git commit -m "chore: add CI/CD workflows and composite actions for automated publishing and docs deployment" || echo "No changes to commit"

          echo "âœ… Workflows and actions added to temp-branch"

      - name: Push to mirror repo
        env:
          MIRROR_REPO_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          MIRROR_URL="${{ needs.detect-package.outputs.mirror-url }}"
          VERSION="${{ needs.detect-package.outputs.version }}"

          # Configure git to use the token
          git config --global credential.helper store
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # Convert https://github.com/org/repo to git URL with token
          GIT_URL=$(echo "$MIRROR_URL" | sed "s|https://|https://x-access-token:${MIRROR_REPO_TOKEN}@|")

          echo "ðŸ”— Setting up remote for $MIRROR_URL"
          git remote add mirror "$GIT_URL"

          echo "â¬†ï¸  Pushing to mirror repository main branch..."
          git push mirror temp-branch:main --force-with-lease || git push mirror temp-branch:main --force

          echo "ðŸ·ï¸  Pushing version tag $VERSION..."
          git push mirror temp-branch:refs/tags/${VERSION} --force

          echo "âœ… Mirror sync complete!"
          echo "   Repository: $MIRROR_URL"
          echo "   Branch: main"
          echo "   Tag: $VERSION"

      - name: Enable GitHub Pages
        env:
          MIRROR_REPO_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          OWNER=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/\([^/]*\)/.*|\1|p')
          REPO=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/[^/]*/\(.*\)|\1|p')
          bun run apps/workflows/src/scripts/mirror-package/enable-github-pages.ts "$OWNER" "$REPO"

      - name: Disable repository features
        env:
          MIRROR_REPO_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          OWNER=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/\([^/]*\)/.*|\1|p')
          REPO=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/[^/]*/\(.*\)|\1|p')
          bun run apps/workflows/src/scripts/mirror-package/disable-repo-features.ts "$OWNER" "$REPO"

      - name: Set branch to read-only
        env:
          MIRROR_REPO_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          OWNER=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/\([^/]*\)/.*|\1|p')
          REPO=$(echo "${{ needs.detect-package.outputs.mirror-url }}" | sed -n 's|https://github.com/[^/]*/\(.*\)|\1|p')
          bun run apps/workflows/src/scripts/mirror-package/set-branch-readonly.ts "$OWNER" "$REPO" "main"

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary branch..."
          git branch -D temp-branch 2>/dev/null || true
          git remote remove mirror 2>/dev/null || true
          echo "âœ… Cleanup complete"

  summary:
    needs: [detect-package, mirror-to-repo]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Job Summary
        run: |
          echo "## ðŸªž Mirror Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`${{ needs.detect-package.outputs.package-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.detect-package.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Mirror URL:** ${{ needs.detect-package.outputs.mirror-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-package.outputs.has-changes }}" == "true" ]; then
            if [ "${{ needs.mirror-to-repo.result }}" == "success" ]; then
              echo "âœ… **Status:** Mirror sync completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Status:** Mirror sync failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸  **Status:** No changes detected - mirror sync skipped" >> $GITHUB_STEP_SUMMARY
          fi
