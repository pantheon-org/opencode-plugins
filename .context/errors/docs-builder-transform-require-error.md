# docs-builder: transform-docs.js — ESM require() ReferenceError

Date: 2025-12-07

## Summary

During `nx` build for the `docs-builder` project the `transform-docs.js` script crashed with a
`ReferenceError: require is not defined in ES module scope`. The build had been running
`bunx nx run-many --target=build --all` which runs the `docs-builder` `build` script. The transform step executes
`node transform-docs.js` and failed because the file is treated as an ES module while it used `require(...)`.

## Stack trace (captured)

```
file:///.../apps/docs-builder/transform-docs.js:25
  const fs = require('fs');
             ^

ReferenceError: require is not defined in ES module scope, you can use import instead
This file is being treated as an ES module because it has a '.js' file extension and '/.../apps/docs-builder/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
    at file:///.../apps/docs-builder/transform-docs.js:25:14
    at file:///.../apps/docs-builder/transform-docs.js:29:3
    at ModuleJob.run (node:internal/modules/esm/module_job:377:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:671:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:101:5)

Node.js v24.11.1
```

(Note: path shortened here for readability; full file path in the run was
`/Users/thomas.roche/Projects/github/pantheon-org/opencode-plugins/apps/docs-builder/transform-docs.js`.)

## What was executing

- Top-level command: `bunx nx run-many --target=build --all` (invoked via `bunx nx run docs-builder:build` as part of
  the run-many set).
- `docs-builder` `build` script runs:
  `bun run generate-favicon && bun run transform && astro build && bun run fix-links`.
- The failing step is the `transform` script, which runs `node transform-docs.js` from `apps/docs-builder/`.

## How we got here (recent changes and actions)

- I modified `apps/docs-builder/transform-docs.js` to make the script prefer the repository root `docs/` folder and to
  gracefully skip the transform when no docs source exists. While doing so I introduced a runtime check using
  `require('fs')` (to test for existence), which worked in CommonJS but not when Node treats the script as an ES module.
- `apps/docs-builder/package.json` has `"type": "module"`, so Node treats `.js` files in that package as ESM. In ESM
  scope `require` is not available, causing the `ReferenceError` during `node transform-docs.js`.

## Reproduction steps

1. From repository root, run: `bunx nx run docs-builder:build` or `bunx nx run-many --target=build --all`.
2. Observe output; the `transform` step runs `node transform-docs.js` and will crash with the ReferenceError if the
   script contains `require('fs')`.

## Suggested fixes

Options (pick one):

- Convert to ESM-compatible code (recommended): use `import { existsSync } from 'fs'` at top-level instead of
  `require('fs')`. We already committed a variant of this in follow-up edits; ensure the final file no longer uses
  `require()`.
- Run the script with Node as CommonJS: rename the script to `transform-docs.cjs` and update npm scripts that call it to
  use the `.cjs` filename (or explicitly call Node with `--input-type=commonjs`), so `require` works as expected.
- Alternatively, keep ESM but avoid `require` by using dynamic import: `const { existsSync } = await import('fs');`
  (note this requires being inside an async context or top-level await depending on Node version and project setup).

I recommend the ESM conversion (use `import`) because the package is already configured with `"type": "module"` and
other build tooling (Astro) expects ESM.

## Files involved

- `apps/docs-builder/transform-docs.js` — script that failed; contains the `require('fs')` call at line ~25 in the
  failing run.
- `apps/docs-builder/package.json` — contains `"type": "module"`, which causes Node to treat `.js` as ESM.
- Build command: `bunx nx run-many --target=build --all` → `docs-builder:build` → `bun run transform` →
  `node transform-docs.js`.

## Notes / Next steps taken

- After the failure I updated `transform-docs.js` to prefer `existsSync` imported from `fs` (ESM import) and added a
  graceful skip if no docs source is present; then committed the change with message:
  `docs-builder: prefer repo-root docs/ and skip transform if missing`.
- I re-ran builds; the transform step later completed successfully once the script used ESM imports.

If you want, I can:

- Revert to a `.cjs` approach instead, or
- Ensure `transform-docs.js` uses only top-level ESM imports and add a unit test for the transform step, or
- Add CI guard to run the transform only if the docs source exists to keep builds deterministic.

---

Generated by automated repo edit on 2025-12-07 to capture the error and context for follow-up debugging and PR notes.
