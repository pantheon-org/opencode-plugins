name: Release Please

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/chores-*.yml'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-please-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      pr: ${{ steps.release.outputs.pr }}

    steps:
      - name: Run Release Please
        id: release
        uses: <%= actions.releasePlease %>
        with:
          token: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      - name: Summary - Release Created
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "## üéâ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Upload URL**: ${{ steps.release.outputs.upload_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Summary - Release PR
        if: steps.release.outputs.pr != ''
        run: |
          echo "## üìù Release PR Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release Please has updated the release PR" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: ${{ steps.release.outputs.prs_created }}" >> $GITHUB_STEP_SUMMARY

      - name: Summary - No Changes
        if: steps.release.outputs.release_created != 'true' && steps.release.outputs.pr == ''
        run: |
          echo "## ‚ÑπÔ∏è No Release Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No conventional commits found that require a release." >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'

    steps:
      - name: Checkout repository
        uses: <%= actions.checkout %>
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: <%= actions.setupBun %>
        with:
          bun-version: latest

      - name: Setup Node.js for npm
        uses: <%= actions.setupNode %>
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache dependencies
        uses: <%= actions.cache %>
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run full validation
        run: |
          echo "üîç Running linter..."
          bun run lint

          echo "üìù Type checking..."
          bun run type-check

          echo "üß™ Running tests with coverage..."
          bun run test:coverage

          echo "üèóÔ∏è Building project..."
          bun run build

      - name: Verify package contents
        run: bun run verify:package

      - name: Check if already published
        id: check-npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION="${{ needs.release-please.outputs.version }}"

          echo "üîç Checking if $PACKAGE_NAME@$VERSION exists on npm..."

          # Try to check if version exists (capture both stdout and stderr)
          NPM_CHECK=$(npm view "$PACKAGE_NAME@$VERSION" version 2>&1 || true)

          if echo "$NPM_CHECK" | grep -q "E404"; then
            echo "‚úÖ Version $VERSION not yet published (404 - not found)"
            echo "published=false" >> $GITHUB_OUTPUT
          elif echo "$NPM_CHECK" | grep -q "$VERSION"; then
            echo "‚ö†Ô∏è Version $VERSION already published to npm"
            echo "published=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Could not determine publication status, assuming not published"
            echo "published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to NPM
        if: steps.check-npm.outputs.published == 'false'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION="${{ needs.release-please.outputs.version }}"

          echo "üöÄ Publishing $PACKAGE_NAME@$VERSION to npm..."

          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "‚ùå Error: NPM_TOKEN secret is not set!"
            echo "Please configure npm authentication:"
            echo "  Option 1 (Recommended): Set up npm provenance with OIDC"
            echo "  Option 2: Add NPM_TOKEN secret with granular access token"
            echo "See: https://docs.npmjs.com/generating-provenance-statements"
            exit 1
          fi

          # Attempt to publish with detailed error handling
          if npm publish --access public --provenance; then
            echo "‚úÖ Successfully published $PACKAGE_NAME@$VERSION to npm"
          else
            NPM_EXIT_CODE=$?
            echo "‚ùå npm publish failed with exit code: $NPM_EXIT_CODE"
            echo ""
            echo "Common causes:"
            echo "  - Expired or invalid NPM_TOKEN"
            echo "  - Token lacks publish permissions for @<%= npmScope %> organization"
            echo "  - Package name already published with this version"
            echo ""
            echo "To fix: Update NPM_TOKEN with a granular access token that has"
            echo "        'Read and write' permissions for this package"
            exit $NPM_EXIT_CODE
          fi

      - name: Verify npm publication
        if: steps.check-npm.outputs.published == 'false'
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION="${{ needs.release-please.outputs.version }}"

          echo "üîç Verifying npm publication..."

          for i in {1..6}; do
            echo "Attempt $i/6..."
            if npm view "$PACKAGE_NAME@$VERSION" version >/dev/null 2>&1; then
              echo "‚úÖ Package verified on npm: $PACKAGE_NAME@$VERSION"
              exit 0
            fi
            
            if [ $i -lt 6 ]; then
              echo "Waiting 15 seconds..."
              sleep 15
            fi
          done

          echo "‚ùå Failed to verify package (may still be propagating)"
          exit 1

      - name: Summary
        run: |
          echo "## ‚úÖ Published to NPM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: @<%= npmScope %>/<%= projectName %>" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.release-please.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY

  publish-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [release-please, publish]
    if: needs.release-please.outputs.release_created == 'true' && success()

    steps:
      - name: Checkout repository
        uses: <%= actions.checkout %>
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: <%= actions.setupBun %>
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: |
          cd pages
          bun install

      - name: Build documentation
        run: |
          cd pages
          bun run build

      - name: Deploy to docs branch
        uses: <%= actions.ghPages %>
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: docs
          publish_dir: ./pages/dist
          force_orphan: false
          enable_jekyll: false
          commit_message: 'docs: Deploy documentation from ${{ github.sha }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Summary
        run: |
          echo "## ‚úÖ Documentation Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: docs" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
