# Lefthook configuration for opencode-plugins
# Leverages Nx to run tasks on affected packages
# For more information: https://lefthook.dev/configuration/

pre-commit:
  parallel: true
  commands:
    # Lint and format affected packages with Biome (combines format + lint)
    biome:
      run: bunx nx affected --target=lint --base=HEAD~1 --head=HEAD --parallel=3 --batch

    # Validate TSDoc on affected packages
    validate-tsdoc:
      run: bunx nx affected --target=validate:tsdoc --base=HEAD~1 --head=HEAD

    # Type-check affected packages using Nx
    type-check:
      run: bunx nx affected --target=type-check --base=HEAD~1 --head=HEAD --parallel=3

    # Lint markdown files in root
    markdown-lint:
      glob: '*.md'
      run: bunx markdownlint-cli2 {staged_files}

    # Validate skills when skill files change
    validate-skills:
      glob: '**/skills/**/*.ts'
      run: bunx nx affected --target=validate:skills --base=HEAD~1 --head=HEAD

    # Validate SKILL.md files when they change
    validate-skill-md:
      glob: '**/SKILL.md'
      run: bunx nx affected --target=validate:skill-md --base=HEAD~1 --head=HEAD

pre-push:
  commands:
    # Run tests on affected packages
    test:
      run: bunx nx affected --target=test --base=origin/main --head=HEAD --parallel=3

    # Build affected packages
    build:
      run: bunx nx affected --target=build --base=origin/main --head=HEAD --parallel=3

    # Lint all affected packages (final check)
    lint-all:
      run: bunx nx affected --target=lint --base=origin/main --head=HEAD --parallel=3

# Skip hooks configuration
# To skip a hook, run: LEFTHOOK=0 git commit
# To skip specific commands: LEFTHOOK_EXCLUDE=lint git commit

output:
  - execution
  - execution_info
